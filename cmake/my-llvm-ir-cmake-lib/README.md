# LLVMIRUtil Documentation

The `LLVMIRUtil.cmake` module provides a set of functions to facilitate generating, linking, optimizing, and compiling LLVM Intermediate Representation (IR) files from CMake targets. It is designed to extract the compile properties from one or more targets and then use LLVM tools (such as Clang, opt, and llc) to produce IR and bitcode files that mimic the original build configuration.

> **Note:** This module requires CMake version 3.30.3 (or later) and depends on additional modules (e.g., `CMakeParseArguments` and `LLVMIRUtilInternal`). A proper LLVM toolchain must also be installed and available on your system.

---

## Table of Contents

- [LLVMIRUtil Documentation](#llvmirutil-documentation)
  - [Table of Contents](#table-of-contents)
  - [Overview](#overview)
  - [Prerequisites](#prerequisites)
  - [Functions Overview](#functions-overview)
    - [llvm\_generate\_ir\_target](#llvm_generate_ir_target)
    - [llvm\_link\_ir\_into\_bc\_target](#llvm_link_ir_into_bc_target)
    - [llvm\_link\_bc\_targets](#llvm_link_bc_targets)
    - [apply\_opt\_to\_bc\_target](#apply_opt_to_bc_target)
    - [llvm\_llc\_into\_obj\_target](#llvm_llc_into_obj_target)
    - [llvm\_compile\_into\_executable\_target](#llvm_compile_into_executable_target)
    - [llvm\_extract\_functions\_to\_bc](#llvm_extract_functions_to_bc)
    - [llvm\_delete\_functions\_from\_bc](#llvm_delete_functions_from_bc)
  - [Helper Functions](#helper-functions)
  - [Usage Examples](#usage-examples)
  - [Troubleshooting](#troubleshooting)
  - [License](#license)

---

## Overview

The module automates the following tasks:

- **IR Generation:**  
  Compiles the source files (excluding headers and other non-compilable files) from specified targets into LLVM IR files (typically with a `.ll` extension).  
- **Property Extraction:**  
  Retrieves compile definitions, include directories, compile options, language standard flags, and library linking information from one or more CMake targets.  
- **Bitcode Linking and Optimization:**  
  Provides functions to link IR files into bitcode (.bc), combine multiple bitcode targets, apply optimization passes via LLVM’s `opt`, and even compile bitcode into object files and executables.
- **Function Extraction/Deletion:**  
  Offers utilities to extract or remove specific functions from bitcode—useful when isolating instrumentation code.

---

## Prerequisites

Before using the functions provided by this module, ensure that:

- **CMake Version:**  
  Your project uses CMake 3.30.3 or later.
- **Module Availability:**  
  The modules `CMakeParseArguments` and `LLVMIRUtilInternal` are in your module path.
- **LLVM Toolchain:**  
  LLVM (including Clang, opt, llc, etc.) is correctly installed and in your PATH.
- **Target Setup:**  
  Dependent targets must have their `SOURCES` property correctly defined.

---

## Functions Overview

### llvm_generate_ir_target

**Description:**  
Generates LLVM IR files from the source files of one or more dependent targets. This function:

- Parses required arguments such as `TARGET` and `DEPEND_TARGETS`.
- Extracts properties (include directories, compile definitions, flags, etc.) from each target.
- Constructs a working directory that mirrors the source tree.
- Adds custom commands to compile each source file (except headers or excluded files) into an IR file.

**Parameters:**

- **TARGET (required):**  
  The name of the output IR target. A dedicated working directory is created under this name.
- **DEPEND_TARGETS (required):**  
  List of CMake targets whose sources will be compiled to IR.
- **EXTRA_FLAGS (optional):**  
  Additional compiler flags to add.
- **EXTRA_INCLUDES (optional):**  
  Extra include directories.
- **EXTRA_LIB_PATHS (optional):**  
  Additional library search paths.
- **EXTRA_LIBS (optional):**  
  Additional libraries to link.

**Usage Example:**

```cmake
llvm_generate_ir_target(
  TARGET my_ir_target
  DEPEND_TARGETS target1 target2
  EXTRA_FLAGS "-O2"
  EXTRA_INCLUDES "${CMAKE_CURRENT_SOURCE_DIR}/include"
  EXTRA_LIB_PATHS "/usr/local/lib"
  EXTRA_LIBS "mylib"
)
```

---

### llvm_link_ir_into_bc_target

**Description:**  
Links one or more LLVM IR files (generated by `llvm_generate_ir_target`) into a single LLVM bitcode file (.bc). This step aggregates IR files so they can be processed as a unified bitcode target.

**Parameters:**

- **TARGET (required):**  
  Name of the output bitcode target.
- **DEPEND_TARGETS (required):**  
  List of targets (usually produced by `llvm_generate_ir_target`) whose IR files will be linked.

**Usage Example:**

```cmake
llvm_link_ir_into_bc_target(
  TARGET my_bitcode_target
  DEPEND_TARGETS my_ir_target
)
```

---

### llvm_link_bc_targets

**Description:**  
Combines multiple bitcode targets into one unified bitcode target. This is useful when you have generated bitcode from different parts of your project and wish to link them into a single file for further processing or optimization.

**Parameters:**

- **TARGET (required):**  
  The name for the final linked bitcode target.
- **DEPEND_TARGETS (required):**  
  A list of bitcode targets to be linked together.

**Usage Example:**

```cmake
llvm_link_bc_targets(
  TARGET final_bitcode
  DEPEND_TARGETS bitcode_target1 bitcode_target2
)
```

---

### apply_opt_to_bc_target

**Description:**  
Applies LLVM optimization passes (using the `opt` tool) to a bitcode target. This function runs the provided optimization commands on the given bitcode to generate an optimized version.

**Parameters:**

- **TARGET (required):**  
  The name of the output target after optimization.
- **DEPEND_TARGET (required):**  
  The bitcode target to which the optimizations are applied.
- **OPT_COMMAND (required):**  
  A list of optimization flags or passes (for example, `-passes=phase-analysis`, etc.) to apply.

**Usage Example:**

```cmake
apply_opt_to_bc_target(
  TARGET optimized_bitcode
  DEPEND_TARGET final_bitcode
  OPT_COMMAND "-passes=mem2reg;-O3"
)
```

---

### llvm_llc_into_obj_target

**Description:**  
Compiles LLVM bitcode into an object file using the LLVM static compiler (llc). This step is usually performed after optimization and before linking an executable.

**Parameters:**

- **TARGET (required):**  
  The name of the object file target.
- **DEPEND_TARGET (required):**  
  The bitcode target to compile.
- **LLC_COMMAND (required):**  
  The command-line options for llc (e.g., specifying the target architecture).

**Usage Example:**

```cmake
llvm_llc_into_obj_target(
  TARGET my_object
  DEPEND_TARGET optimized_bitcode
  LLC_COMMAND "-march=x86-64"
)
```

---

### llvm_compile_into_executable_target

**Description:**  
Links object files (or bitcode targets) into a final executable. This function aggregates all required objects, applies additional flags, and invokes the compiler/linker to produce an executable binary.

**Parameters:**

- **TARGET (required):**  
  The name of the final executable target.
- **DEPEND_TARGETS (required):**  
  A list of object targets (or bitcode targets, if linking is performed directly) to be linked.
- **EXTRA_FLAGS (optional):**  
  Additional compiler or linker flags.
- **EXTRA_LIB_PATHS (optional):**  
  Additional library search paths.
- **EXTRA_LIBS (optional):**  
  Extra libraries to link.

**Usage Example:**

```cmake
llvm_compile_into_executable_target(
  TARGET my_executable
  DEPEND_TARGETS my_object1 my_object2
  EXTRA_FLAGS "-O2"
  EXTRA_LIB_PATHS "/usr/local/lib"
  EXTRA_LIBS "pthread;ssl"
)
```

---

### llvm_extract_functions_to_bc

**Description:**  
Extracts specific functions from an existing bitcode target into a new bitcode target. This is useful when you want to isolate certain functions (for example, instrumentation or hook routines) for separate handling.

**Parameters:**

- **TARGET (required):**  
  The name of the output bitcode target containing only the extracted functions.
- **DEPEND_TARGET (required):**  
  The original bitcode target from which functions will be extracted.
- **FUNCTIONS (required):**  
  A list of function names to extract.

**Usage Example:**

```cmake
llvm_extract_functions_to_bc(
  TARGET extracted_bc
  DEPEND_TARGET full_bitcode
  FUNCTIONS "funcA" "funcB" "funcC"
)
```

---

### llvm_delete_functions_from_bc

**Description:**  
Removes specified functions from a bitcode target. This function is useful to remove unwanted or redundant code (such as hook functions) from a source bitcode target.

**Parameters:**

- **TARGET (required):**  
  The name of the new bitcode target after deletion.
- **DEPEND_TARGET (required):**  
  The original bitcode target.
- **FUNCTIONS (required):**  
  A list of function names to be removed.

**Usage Example:**

```cmake
llvm_delete_functions_from_bc(
  TARGET cleaned_bc
  DEPEND_TARGET full_bitcode
  FUNCTIONS "funcA" "funcB"
)
```

---

## Helper Functions

In addition to the main functions described above, the module relies on several helper routines (typically defined in the `LLVMIRUtilInternal` module) to extract properties from targets:

- **llvmir_extract_compile_defs_properties:**  
  Extracts compile definitions (e.g., `-D` flags).

- **llvmir_extract_include_dirs_properties:**  
  Extracts include directories (e.g., `-I` paths).

- **llvmir_extract_standard_flags:**  
  Retrieves language standard flags (e.g., `-std=c++11`) for a specified language.

- **llvmir_extract_compile_option_properties:**  
  Gathers compile options from the target.

- **llvmir_extract_compile_flags:**  
  Extracts compile flags specific to the target’s build configuration.

- **llvmir_extract_lang_flags:**  
  Extracts language-specific flags (such as optimization flags like `-O3`).

- **llvmir_extract_library_linking:**  
  Retrieves library linking information, including library paths and libraries.
  
- **llvmir_extract_library_compile_option:**  
  Extracts additional compile options related to linked libraries.
  
- **llvmir_extract_library_include:**  
  Retrieves include directories coming from library dependencies.
  
- **llvmir_extract_file_lang:**  
  Determines the language of a source file based on its file extension.

These helper functions ensure that the IR and bitcode generation processes accurately mirror the original compilation environment.

---

## Usage Examples

Below is an example integration of several functions from the module into a CMake project:

```cmake
cmake_minimum_required(VERSION 3.30.3)
project(MyLLVMProject)

# Add custom module path to locate LLVMIRUtil.cmake and related modules.
list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake/my-llvm-ir-cmake-lib")
include(LLVMIRUtil.cmake)

# Define some targets with sources.
add_library(target1 STATIC src/target1.cpp)
add_library(target2 STATIC src/target2.cpp)

# Set output directory for LLVM IR files.
set(LLVM_IR_OUTPUT_DIR "llvm_ir")

# Generate LLVM IR files from the targets.
llvm_generate_ir_target(
  TARGET my_ir_target
  DEPEND_TARGETS target1 target2
  EXTRA_FLAGS "-O2"
  EXTRA_INCLUDES "${CMAKE_CURRENT_SOURCE_DIR}/include"
)

# Link the generated IR files into a single bitcode target.
llvm_link_ir_into_bc_target(
  TARGET my_bitcode
  DEPEND_TARGETS my_ir_target
)

# Optionally, link multiple bitcode targets together.
llvm_link_bc_targets(
  TARGET combined_bitcode
  DEPEND_TARGETS my_bitcode another_bitcode_target
)

# Apply LLVM optimization passes to the bitcode.
apply_opt_to_bc_target(
  TARGET optimized_bitcode
  DEPEND_TARGET my_bitcode
  OPT_COMMAND "-passes=mem2reg;-O3"
)

# Compile the optimized bitcode into an object file.
llvm_llc_into_obj_target(
  TARGET my_object
  DEPEND_TARGET optimized_bitcode
  LLC_COMMAND "-march=x86-64"
)

# Link the object file(s) into a final executable.
llvm_compile_into_executable_target(
  TARGET my_executable
  DEPEND_TARGETS my_object
  EXTRA_FLAGS "-O2"
  EXTRA_LIBS "pthread"
)

# (Optional) Extract specific functions from a bitcode target.
llvm_extract_functions_to_bc(
  TARGET extracted_bc
  DEPEND_TARGET optimized_bitcode
  FUNCTIONS "hook_function"
)

# (Optional) Delete unwanted functions from a bitcode target.
llvm_delete_functions_from_bc(
  TARGET cleaned_bc
  DEPEND_TARGET optimized_bitcode
  FUNCTIONS "debug_function"
)
```

---

## Troubleshooting

- **Missing SOURCES Property:**  
  If a dependent target lacks the `SOURCES` property, `llvm_generate_ir_target` will trigger a fatal error. Verify that each target properly defines its source files.

- **Directory Creation Errors:**  
  If the working directory for IR generation cannot be created, check your write permissions and the correctness of the specified output path.

- **Unsupported Flags:**  
  The module checks for LLVM compiler flag support; unsupported flags are dropped with a warning message. Adjust your extra flags as needed.

- **Dependency Ordering:**  
  Ensure that targets specified in `DEPEND_TARGETS` are built (or defined) before invoking these functions to guarantee proper dependency tracking.

---

## License

This module is part of the [nugget_util](https://github.com/studyztp/nugget_util) project and is distributed under the same license as the main repository. See the [LICENSE](https://github.com/studyztp/nugget_util/blob/main/LICENSE) file for details.

